<template>
  <div>
    <h2>报表：巡检记录</h2>
    <!-- 输入面板 -->
    <div>
      <label>车间：
        <select v-model="selectedWorkshop">
          <option v-for="w in workshops" :value="w">{{w.name}}</option>
        </select>
      </label>
    </div>
    <div>
      <label>起始日期：
        <input type="date" v-model="startDate">
      </label>
    </div>
    <div>
      <label>截止日期：
        <input type="date" v-model="endDate">
      </label>
    </div>
    <div>状态：
      <label>
        <input type="radio" v-model="normality" value="normal">正常
      </label>
      <label>
        <input type="radio" v-model="normality" value="abnormal">异常
      </label>
    </div>
    <div style="text-align:center;margin-top: 12px">
      <button @click="onQuery">查询</button>
      <button @click="onExport">导出</button>
    </div>
    <!-- 结果网格 -->
    <div style="overflow-x: scroll">
      <table style="min-width: 560px;">
        <thead>
          <tr>
            <th>区段</th>
            <th>设备</th>
            <th>状态</th>
            <th>缺陷</th>
            <th>巡检时间</th>
            <th>巡检人</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="i in inspects" @click="selectedInspect=i" :class="{selected: selectedInspect===i}">
            <td>{{i.section}}</td>
            <td>{{i.device}}</td>
            <td>{{i.deviceStatus}}</td>
            <td>{{i.fault || '无'}}</td>
            <td>{{i.createTime | datetime}}</td>
            <td>{{i.user}}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div v-if="selectedInspect" style="border-top: 1px solid blue">
      <div>巡检照片</div>
      <div>
        <div style="float:left;width:33%" v-for="i in selectedInspect.images">
          <img style="width:100%;" :src="i.url" @click="selectedImage=i">
        </div>
      </div>
    </div>

    <!-- 大照片 -->
    <div v-if="selectedImage" style="position: fixed; left:0; top:0; right:0;bottom:0; background-color: gray; overflow:scroll">
      <img :src="selectedImage.url" style="width:100%" @click="selectedImage=null">
    </div>
  </div>
</template>

<style>
.selected {
  color: white;
  background-color: blue;
}
</style>


<script>
export default {
  data() {
    return {
      workshops: [],
      selectedWorkshop: null,
      startDate: this.$moment()
        .subtract(7, 'days')
        .format('YYYY-MM-DD'),
      endDate: this.$moment().format('YYYY-MM-DD'),
      normality: 'abnormal',
      inspects: [],
      selectedInspect: null,
      selectedImage: null
    }
  },
  mounted() {
    this.loadWorkshops()
  },
  methods: {
    loadWorkshops() {
      this.$axios.get('/api/workshops').then(r => {
        this.workshops = r.data.filter(e => {
          return e.id > 1
        })
        if (this.workshops.length > 0) {
          this.selectedWorkshop = this.workshops[0]
        }
      })
    },

    onQuery() {
      this.$axios
        .get('/api/inspects', {
          params: {
            w: this.selectedWorkshop.name,
            d1: this.startDate,
            d2: this.endDate,
            n: this.normality
          }
        })
        .then(r => {
          this.inspects = r.data
        })
    },
    onExport() {
      let url = `/api/inspects?w=${this.selectedWorkshop.name}&d1=${
        this.startDate
      }&d2=${this.endDate}&_export=true`
      window.open(url, '_blank')
    }
  }
}
</script>
